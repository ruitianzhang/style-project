{% extends "base.html" %}

{% block content %}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0" style="color: #D4A5A5;">ğŸŒŸ ç©¿æ­ç¤¾ç¾¤ç‰†</h3>
            <small class="text-muted">æ¢ç´¢éˆæ„Ÿï¼Œåƒèˆ‡æŠ•ç¥¨ï¼Œèˆ‡å°ˆå®¶äº’å‹•</small>
        </div>
        <a href="{{ url_for('new_post') }}" class="btn btn-style rounded-pill px-4 shadow-sm">
            <i class="fas fa-camera me-2"></i> ç™¼ä½ˆç©¿æ­
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">

            {% for post in posts %}
            <div class="glass-card mb-5 p-0 overflow-hidden position-relative fade-in">

                <div class="p-3 d-flex justify-content-between align-items-center border-bottom bg-white bg-opacity-50">
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3 border" style="width: 45px; height: 45px;">
                            <i class="fas fa-user text-secondary fa-lg"></i>
                        </div>

                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold text-dark">{{ post.author_name }}</span>

                                {% if post.author_role == 'official' %}
                                    <span class="badge bg-primary rounded-pill" title="å®˜æ–¹å¸³è™Ÿ">
                                        <i class="fas fa-check-circle me-1"></i>Official
                                    </span>
                                {% elif post.author_role == 'expert' %}
                                    <span class="badge bg-warning text-dark rounded-pill" title="èªè­‰å°ˆå®¶">
                                        <i class="fas fa-star me-1"></i>Expert
                                    </span>
                                {% endif %}

                                {% if post.is_vip %}
                                    <span class="badge bg-dark text-warning rounded-pill" title="VIP æœƒå“¡">
                                        <i class="fas fa-crown"></i>
                                    </span>
                                {% endif %}
                            </div>
                            <small class="text-muted" style="font-size: 0.8rem;">
                                {{ post.created_at }}
                                {% if post.is_anonymous %} <i class="fas fa-mask ms-1" title="åŒ¿åç™¼æ–‡"></i> {% endif %}
                            </small>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        {% if post.author_id != session['user_id'] %}
                            <button class="btn btn-sm {{ 'btn-secondary' if post.is_following else 'btn-outline-primary' }} rounded-pill px-3"
                                    onclick="toggleFollow(this, {{ post.author_id }})">
                                {{ 'å·²è¿½è¹¤' if post.is_following else 'è¿½è¹¤' }}
                            </button>
                        {% endif %}
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-muted" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                <li><a class="dropdown-item text-danger" href="#" onclick="openReportModal({{ post.id }})">æª¢èˆ‰è²¼æ–‡</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="position-relative">
                    <img src="{{ url_for('static', filename=post.image) }}" class="w-100" style="max-height: 600px; object-fit: cover;" alt="Post Image">

                    {% if post.is_qa %}
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge bg-info text-white shadow fw-bold px-3 py-2 rounded-pill">
                            <i class="fas fa-question-circle me-1"></i> æå•ä¸­
                        </span>
                    </div>
                    {% endif %}
                </div>

                {% if post.is_qa %}
                <div class="p-4 bg-light bg-opacity-50 border-bottom border-top">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0 text-primary">
                            <i class="fas fa-poll me-2"></i>å¤§å®¶è¦ºå¾—é©åˆæˆ‘å—ï¼Ÿ
                        </h6>
                        <button class="btn btn-sm btn-outline-info rounded-pill shadow-sm hover-scale" onclick="askAiWhy('{{ post.id }}')">
                            <i class="fas fa-robot me-1"></i> AI å¹«æˆ‘çœ‹
                        </button>
                    </div>

                    <div class="d-flex gap-3 align-items-center">
                        <button class="btn btn-outline-success flex-grow-1 py-2 rounded-pill" onclick="vote('{{ post.id }}', 'yes')">
                            <i class="far fa-circle me-1"></i> é©åˆ (<span id="yes-{{ post.id }}">{{ post.poll_yes }}</span>)
                        </button>
                        <button class="btn btn-outline-danger flex-grow-1 py-2 rounded-pill" onclick="vote('{{ post.id }}', 'no')">
                            <i class="fas fa-times me-1"></i> ä¸é©åˆ (<span id="no-{{ post.id }}">{{ post.poll_no }}</span>)
                        </button>
                    </div>

                    <div class="progress mt-3 rounded-pill" style="height: 12px; background-color: #ffdcdccc;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ post.yes_percent }}%; transition: width 0.5s;" id="bar-{{ post.id }}"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-success">é©åˆåº¦</small>
                        <small class="text-muted" id="percent-text-{{ post.id }}">{{ post.yes_percent }}%</small>
                    </div>
                </div>
                {% endif %}

                <div class="p-3">
                    <div class="d-flex gap-3 mb-3">
                        <i class="fas fa-heart fa-lg cursor-pointer hover-scale {{ 'text-danger' if post.is_liked else 'text-muted' }}"
                           onclick="toggleLike(this, {{ post.id }})"></i>
                        <i class="far fa-comment fa-lg text-muted cursor-pointer hover-scale" onclick="document.getElementById('comment-input-{{ post.id }}').focus()"></i>
                        <i class="far fa-paper-plane fa-lg text-muted ms-auto cursor-pointer hover-scale"></i>
                    </div>

                    <p class="mb-1 fw-bold text-dark"><span id="like-count-{{ post.id }}">{{ post.likes_count }}</span> å€‹è®š</p>

                    <div class="mb-2">
                        <span class="fw-bold text-dark">{{ post.author_name }}</span>
                        <span class="text-secondary">{{ post.content }}</span>
                    </div>

                    <div class="mb-3">
                        {% for tag in post.tags %}
                        <a href="#" class="text-decoration-none me-1">
                            <span class="badge bg-secondary bg-opacity-10 text-primary border border-primary border-opacity-25 rounded-pill fw-normal">#{{ tag }}</span>
                        </a>
                        {% endfor %}
                    </div>

                    {% if post.comments %}
                    <div class="bg-light bg-opacity-50 p-3 rounded-3 mb-3">
                        <div class="overflow-auto" style="max-height: 150px;">
                            {% for comment in post.comments %}
                            <div class="mb-2 small border-bottom pb-1 border-white">
                                <span class="fw-bold text-dark">{{ comment.commenter_name }}</span>
                                {% if comment.commenter_role == 'expert' %}<i class="fas fa-star text-warning small" title="å°ˆå®¶"></i>{% endif %}
                                : <span class="text-muted">{{ comment.content }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <form action="/api/comment_post/{{ post.id }}" method="POST" class="d-flex gap-2 align-items-center">
                        <div class="flex-grow-1 position-relative">
                            <input type="text" id="comment-input-{{ post.id }}" name="content" class="form-control rounded-pill bg-light border-0 px-3" placeholder="æ–°å¢ç•™è¨€..." required>
                        </div>
                        <button type="submit" class="btn btn-link text-decoration-none fw-bold p-0" style="color: #D4A5A5;">ç™¼ä½ˆ</button>
                    </form>
                </div>
            </div>
            {% endfor %}

            <div class="text-center pb-5 text-muted small">
                <i class="fas fa-check-circle me-1"></i> å·²é¡¯ç¤ºæ‰€æœ‰æœ€æ–°å‹•æ…‹
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">æª¢èˆ‰è²¼æ–‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">è«‹é¸æ“‡æª¢èˆ‰åŸå› ï¼Œæˆ‘å€‘å°‡æœƒç›¡å¿«å¯©æ ¸ï¼š</p>
                <input type="hidden" id="reportPostId">
                <select class="form-select mb-3 rounded-pill" id="reportReason">
                    <option>ä¸ç•¶å…§å®¹ (è‰²æƒ…/æš´åŠ›)</option>
                    <option>åƒåœ¾è¨Šæ¯ / å»£å‘Š</option>
                    <option>éœ¸å‡Œæˆ–é¨·æ“¾</option>
                    <option>ä»‡æ¨è¨€è«–</option>
                    <option>å…¶ä»–åŸå› </option>
                </select>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" onclick="submitReport()">æäº¤æª¢èˆ‰</button>
            </div>
        </div>
    </div>
</div>

<script>
// 1. æŠ•ç¥¨åŠŸèƒ½
function vote(postId, type) {
    fetch('/api/vote_post', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ post_id: postId, vote: type })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById(`yes-${postId}`).innerText = data.yes;
        document.getElementById(`no-${postId}`).innerText = data.no;
        document.getElementById(`bar-${postId}`).style.width = data.percent + '%';
        document.getElementById(`percent-text-${postId}`).innerText = data.percent + '%';
    });
}

// 2. AI è§£é‡‹æŠ•ç¥¨
function askAiWhy(postId) {
    let yes = parseInt(document.getElementById(`yes-${postId}`).innerText);
    let no = parseInt(document.getElementById(`no-${postId}`).innerText);

    // é¡¯ç¤º Loading
    let btn = event.currentTarget;
    let originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ†æä¸­';
    btn.disabled = true;

    fetch('/api/ai_explain_vote', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ yes: yes, no: no, tags: [] })
    })
    .then(r => r.json())
    .then(data => {
        alert(`ğŸ¤– AI æ™‚å°šåˆ†æï¼š\n\n${data.reason}`);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}

// 3. æŒ‰è®šåŠŸèƒ½
function toggleLike(btn, postId) {
    fetch(`/api/like_post/${postId}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            btn.classList.toggle('text-danger');
            btn.classList.toggle('text-muted');
            // ç°¡å–®å‹•ç•«
            btn.style.transform = "scale(1.2)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);

            let countSpan = document.getElementById(`like-count-${postId}`);
            let current = parseInt(countSpan.innerText);
            countSpan.innerText = data.action === 'liked' ? current + 1 : current - 1;
        }
    });
}

// 4. è¿½è¹¤åŠŸèƒ½
function toggleFollow(btn, userId) {
    fetch(`/api/follow_user/${userId}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            btn.innerText = data.action === 'followed' ? 'å·²è¿½è¹¤' : 'è¿½è¹¤';
            btn.classList.toggle('btn-secondary');
            btn.classList.toggle('btn-outline-primary');
        } else if (data.status === 'error') {
            alert(data.msg);
        }
    });
}

// 5. æª¢èˆ‰åŠŸèƒ½
function openReportModal(postId) {
    document.getElementById('reportPostId').value = postId;
    new bootstrap.Modal(document.getElementById('reportModal')).show();
}

function submitReport() {
    let postId = document.getElementById('reportPostId').value;
    let reason = document.getElementById('reportReason').value;
    let formData = new FormData();
    formData.append('reason', reason);

    fetch(`/api/report_post/${postId}`, { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
        alert('æª¢èˆ‰å·²æäº¤ï¼Œæ„Ÿè¬æ‚¨ç¶­è­·ç¤¾ç¾¤ç’°å¢ƒã€‚');
        location.reload();
    });
}
</script>

<style>
    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
    .hover-scale:hover { transform: scale(1.1); transition: 0.2s; }
</style>
{% endblock %}
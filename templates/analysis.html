{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">

        <div class="position-relative m-4">
            <div class="progress" style="height: 2px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: 33%;" id="progressBar"></div>
            </div>
            <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-danger rounded-pill" style="width: 2rem; height:2rem;">1</div>
            <div class="position-absolute top-0 start-50 translate-middle btn btn-sm btn-secondary rounded-pill" style="width: 2rem; height:2rem;" id="step2Indicator">2</div>
            <div class="position-absolute top-0 start-100 translate-middle btn btn-sm btn-secondary rounded-pill" style="width: 2rem; height:2rem;" id="step3Indicator">3</div>
        </div>

        <div id="step1" class="glass-card fade-in">
            <h3 class="fw-bold mb-4" style="color: #D4A5A5;"><i class="fas fa-camera me-2"></i>Step 1. è‡‰å‹èˆ‡äº”å®˜åˆ†æ</h3>
            <div class="row align-items-center">
                <div class="col-md-6 text-center border-end">

                    <div class="position-relative mb-3 bg-light rounded-3 overflow-hidden d-flex justify-content-center align-items-center" style="height: 300px; border: 2px dashed #ccc;">
                        <div id="placeholderText" class="text-muted">
                            <i class="fas fa-user-circle fa-4x mb-2"></i>
                            <p>è«‹é¸æ“‡ä¸Šå‚³æˆ–æ‹ç…§</p>
                        </div>
                        <video id="cameraStream" autoplay playsinline class="w-100 h-100 d-none" style="object-fit: cover;"></video>
                        <img id="imagePreview" src="" class="w-100 h-100 d-none" style="object-fit: cover;">
                        <canvas id="canvas" class="d-none"></canvas>
                    </div>

                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-outline-secondary rounded-pill" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-upload me-1"></i> ä¸Šå‚³ç…§ç‰‡
                        </button>
                        <input type="file" id="imageInput" class="d-none" accept="image/*" onchange="handleFileUpload(this)">

                        <button id="btnOpenCamera" class="btn btn-outline-danger rounded-pill" onclick="startCamera()">
                            <i class="fas fa-video me-1"></i> é–‹å•Ÿç›¸æ©Ÿ
                        </button>
                        <button id="btnCapture" class="btn btn-danger rounded-pill d-none" onclick="takePhoto()">
                            <i class="fas fa-camera me-1"></i> æ‹ç…§åˆ†æ
                        </button>
                    </div>
                </div>

                <div class="col-md-6 ps-md-4">
                    <div id="faceLoading" class="text-center d-none mt-4 mt-md-0">
                        <div class="spinner-border text-danger" role="status"></div>
                        <p class="mt-2 text-muted">AI æ­£åœ¨è­˜åˆ¥è‡‰éƒ¨ç‰¹å¾µ...</p>
                    </div>

                    <div id="faceResult" class="d-none mt-4 mt-md-0">
                        <h4 class="fw-bold text-dark mb-3">è¾¨è­˜æˆåŠŸ</h4>
                        <div class="p-3 bg-white rounded-3 shadow-sm mb-3 border-start border-4 border-danger">
                            <h5 class="fw-bold text-danger" id="faceShapeRes"></h5>
                            <hr>
                            <ul class="list-unstyled text-muted small mt-2" id="faceDetails" style="line-height: 2;"></ul>
                        </div>
                        <button class="btn btn-style w-100 rounded-pill py-2 shadow" onclick="goToStep2()">
                            ä¸‹ä¸€æ­¥ï¼šèº«æåˆ†æ <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="step2" class="glass-card fade-in d-none">
            <h3 class="fw-bold mb-4" style="color: #D4A5A5;">
                <i class="fas fa-magic me-2"></i>Step 2. æ‚¨çš„ç©¿æ­ç›®æ¨™
            </h3>
            <div class="row">
                <div class="col-md-6 border-end">
                    <h5 class="mb-3 text-secondary">åŸºç¤æ•¸æ“š (cm)</h5>
                    <div class="row g-3">
                        <div class="col-6"><label>è‚©å¯¬</label><input type="number" id="shoulder" class="form-control" placeholder="é¸å¡«"></div>
                        <div class="col-6"><label>èƒ¸åœ</label><input type="number" id="chest" class="form-control" placeholder="é¸å¡«"></div>
                        <div class="col-6"><label>è…°åœ</label><input type="number" id="waist" class="form-control" placeholder="é¸å¡«"></div>
                        <div class="col-6"><label>è‡€åœ</label><input type="number" id="hip" class="form-control" placeholder="é¸å¡«"></div>
                    </div>
                </div>
                <div class="col-md-6 ps-md-4">
                    <h5 class="mb-3 text-secondary">æ‚¨å¸Œæœ›é€éç©¿æ­é”åˆ°ä»€éº¼æ•ˆæœï¼Ÿ</h5>
                    <div class="d-flex flex-wrap gap-2">
                        {% set goals = [
                            ('ä¿®é£¾è‚©éƒ¨ç·šæ¢', 'shoulder'),
                            ('å„ªåŒ–èº«å½¢æ¯”ä¾‹', 'ratio'),
                            ('è…¹éƒ¨è¦–è¦ºå¹³å¦', 'belly'),
                            ('æŒºæ‹”èº«å§¿', 'posture'),
                            ('ä¿®é£¾è‡€è…¿ç·šæ¢', 'hip'),
                            ('æ‰‹è‡‚ç·šæ¢æŸ”å’Œ', 'arm'),
                            ('æ‹‰é•·è…¿éƒ¨è¦–è¦º', 'leg')
                        ] %}

                        {% for label, val in goals %}
                        <input type="checkbox" class="btn-check" id="goal_{{loop.index}}" value="{{val}}">
                        <label class="btn btn-outline-secondary btn-sm rounded-pill border-0 shadow-sm" for="goal_{{loop.index}}" style="padding: 8px 16px;">
                            {{label}}
                        </label>
                        {% endfor %}
                    </div>
                    <div class="mt-3 small text-muted">
                        <i class="fas fa-heart text-danger me-1"></i> æ¯å€‹èº«å½¢éƒ½æ˜¯ç¨ä¸€ç„¡äºŒçš„ï¼Œæˆ‘å€‘å°‡å”åŠ©æ‚¨å±•ç¾æœ€è‡ªä¿¡çš„ä¸€é¢ã€‚
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-style btn-lg rounded-pill px-5 shadow" onclick="analyzeBody()">
                    ç”Ÿæˆå°ˆå±¬å»ºè­° <i class="fas fa-wand-magic-sparkles ms-2"></i>
                </button>
            </div>
        </div>

        <div id="step3" class="glass-card fade-in d-none">
            <div class="text-center mb-5">
                <h2 class="fw-bold" style="color: #D4A5A5;">âœ¨ æ‚¨çš„å…¨æ–¹ä½å½¢è±¡å ±å‘Š</h2>
            </div>

            <div class="alert alert-warning text-center rounded-pill shadow-sm mb-4">
                <h4 class="fw-bold mb-0" id="styleSummary"></h4>
            </div>

            <div class="row g-4">
                <div class="col-md-4">
                    <div class="bg-white p-4 rounded-4 shadow-sm h-100 border-top border-4 border-warning">
                        <h5 class="fw-bold mb-3">é«®å‹å»ºè­°</h5>
                        <p id="hairRec" class="text-muted"></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="bg-white p-4 rounded-4 shadow-sm h-100 border-top border-4 border-danger">
                        <h5 class="fw-bold mb-3">å¦å®¹æ–¹å‘</h5>
                        <p id="makeupRec" class="text-muted"></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="bg-white p-4 rounded-4 shadow-sm h-100 border-top border-4 border-info">
                        <h5 class="fw-bold mb-3">é…ä»¶é»ç¶´</h5>
                        <p id="accRec" class="text-muted"></p>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button class="btn btn-outline-primary w-100 rounded-pill border-2 dashed-border" type="button" data-bs-toggle="collapse" data-bs-target="#logicCollapse">
                    <i class="fas fa-lightbulb me-2"></i> ç‚ºä»€éº¼ AI é€™æ¨£å»ºè­°ï¼Ÿ (é»æ“ŠæŸ¥çœ‹æ¨è«–é‚è¼¯)
                </button>

                <div class="collapse mt-3" id="logicCollapse">
                    <div class="card card-body bg-light border-0 rounded-4">
                        <h6 class="fw-bold text-primary mb-3">ğŸ§  AI æ€è€ƒè·¯å¾‘è§£æ (XAI)</h6>
                        <ul class="list-group list-group-flush bg-transparent" id="logicTraceList">
                            </ul>
                        <div class="mt-3 small text-muted border-top pt-2">
                            é€™å°±æ˜¯æˆ‘å€‘ç‚ºæ‚¨é‡èº«æ‰“é€ çš„æ±ºç­–éç¨‹ã€‚å­¸æœƒé€™äº›é‚è¼¯ï¼Œæ‚¨ä¹Ÿèƒ½æˆç‚ºè‡ªå·±çš„é€ å‹å¸«ï¼
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 p-4 bg-light rounded-4 border-start border-4 border-success">
                <h5 class="fw-bold mb-3 text-success">é©åˆå–®å“</h5>
                <div id="suitableList" class="d-flex flex-wrap gap-2"></div>
            </div>

            <div class="mt-4 p-4 bg-light rounded-4 border-start border-4 border-secondary">
                <h5 class="fw-bold mb-3 text-secondary">é¿é›·å–®å“</h5>
                <div id="avoidList" class="d-flex flex-wrap gap-2"></div>
            </div>

            <div class="text-center mt-5">
                <a href="{{ url_for('history_page') }}" class="btn btn-style rounded-pill">å„²å­˜è‡³æ­·å²ç´€éŒ„</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let analysisData = { face: {}, body: {} };
let videoStream = null;

// ç›¸æ©ŸåŠŸèƒ½
async function startCamera() {
    try {
        const video = document.getElementById('cameraStream');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoStream = stream;
        video.srcObject = stream;
        video.classList.remove('d-none');
        document.getElementById('imagePreview').classList.add('d-none');
        document.getElementById('placeholderText').classList.add('d-none');
        document.getElementById('btnOpenCamera').classList.add('d-none');
        document.getElementById('btnCapture').classList.remove('d-none');
    } catch (err) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ"); }
}

function takePhoto() {
    const video = document.getElementById('cameraStream');
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    canvas.toBlob(blob => {
        uploadAndAnalyzeFace(new File([blob], "webcam.jpg", { type: "image/jpeg" }));
    }, 'image/jpeg');
    stopCamera();
    document.getElementById('imagePreview').src = canvas.toDataURL('image/jpeg');
    document.getElementById('imagePreview').classList.remove('d-none');
    document.getElementById('cameraStream').classList.add('d-none');
}

function stopCamera() {
    if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
    document.getElementById('btnCapture').classList.add('d-none');
    document.getElementById('btnOpenCamera').classList.remove('d-none');
}

function handleFileUpload(input) {
    if (input.files[0]) {
        let r = new FileReader();
        r.onload = e => {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').classList.remove('d-none');
            document.getElementById('placeholderText').classList.add('d-none');
            stopCamera();
            uploadAndAnalyzeFace(input.files[0]);
        };
        r.readAsDataURL(input.files[0]);
    }
}

// ==========================================
// API ä¸²æ¥èˆ‡é˜²æ¿«ç”¨è™•ç†
// ==========================================
function uploadAndAnalyzeFace(file) {
    let fd = new FormData();
    fd.append('image', file);

    document.getElementById('faceLoading').classList.remove('d-none');
    document.getElementById('faceResult').classList.add('d-none');

    fetch('/api/analyze_face', { method: 'POST', body: fd })
    .then(r => r.json()).then(data => {
        document.getElementById('faceLoading').classList.add('d-none');

        // è™•ç† 1: éåº¦ä¾è³´è­¦å‘Š (Warning)
        if (data.status === 'warning') {
            alert(data.msg);
            document.getElementById('placeholderText').classList.remove('d-none');
            document.getElementById('imagePreview').classList.add('d-none');
            document.getElementById('imageInput').value = '';
            return;
        }

        // è™•ç† 2: åœ–åƒæ¿«ç”¨éŒ¯èª¤ (Error)
        if (data.status === 'error') {
            alert(data.msg);
            document.getElementById('placeholderText').classList.remove('d-none');
            document.getElementById('imagePreview').classList.add('d-none');
            document.getElementById('imageInput').value = '';
            return;
        }

        // è™•ç† 3: æˆåŠŸ (Success)
        document.getElementById('faceResult').classList.remove('d-none');
        analysisData.face = data.data;
        document.getElementById('faceShapeRes').innerText = data.data.shape;
        document.getElementById('faceDetails').innerHTML = `
            <li>çœ¼å‹ï¼š${data.data.features.eyes}</li>
            <li>é¼»å‹ï¼š${data.data.features.nose}</li>
            <li class="text-danger mt-2 small border-top pt-2">
                <i class="fas fa-exclamation-circle me-1"></i> ${data.disclaimer || 'åƒ…ä¾›åƒè€ƒ'}
            </li>
        `;
    });
}

function goToStep2() {
    document.getElementById('step1').classList.add('d-none');
    document.getElementById('step2').classList.remove('d-none');
    document.getElementById('progressBar').style.width = "66%";
    document.getElementById('step2Indicator').classList.add('btn-danger');
}

function analyzeBody() {
    let problems = [];
    document.querySelectorAll('input[type=checkbox]:checked').forEach(el => problems.push(el.value));
    let bodyData = {
        shoulder: document.getElementById('shoulder').value,
        chest: document.getElementById('chest').value,
        waist: document.getElementById('waist').value,
        hip: document.getElementById('hip').value,
        problems: problems
    };

    fetch('/api/analyze_body', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(bodyData)
    }).then(r => r.json()).then(data => {
        analysisData.body = data.data;
        generateFinalResult(problems);
    });
}

function generateFinalResult(problems) {
    fetch('/api/generate_full_report', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ face_data: analysisData.face, body_data: { shape: analysisData.body.shape, problems: problems } })
    }).then(r => r.json()).then(data => {
        document.getElementById('step2').classList.add('d-none');
        document.getElementById('step3').classList.remove('d-none');
        document.getElementById('progressBar').style.width = "100%";
        document.getElementById('step3Indicator').classList.add('btn-danger');

        document.getElementById('styleSummary').innerText = `ğŸ¯ ${data.result.summary}`;
        document.getElementById('hairRec').innerText = data.result.hair;
        document.getElementById('makeupRec').innerText = data.result.makeup;
        document.getElementById('accRec').innerText = data.result.accessories;

        // --- NEW: è™•ç†æ•™å­¸æ¨¡å¼é‚è¼¯é¡¯ç¤º (Logic Trace) ---
        let traceList = document.getElementById('logicTraceList');
        traceList.innerHTML = ''; // æ¸…ç©º

        // è§£æé‚è¼¯å­—ä¸²
        let rawTrace = data.result.logic_trace || "STEP 1 [åˆ†æ] ç¶œåˆè©•ä¼° -> STEP 2 [å»ºè­°] ç”Ÿæˆçµæœ";
        let steps = rawTrace.split(' -> ');

        steps.forEach((step, index) => {
            let parts = step.match(/\[(.*?)\]\s*(.*)/); // æ­£å‰‡æ‹†åˆ† [Tag] Content
            let tag = parts ? parts[1] : `Step ${index+1}`;
            let content = parts ? parts[2] : step;

            let li = document.createElement('li');
            li.className = "list-group-item bg-transparent d-flex align-items-start";
            li.innerHTML = `
                <span class="badge bg-primary me-2 rounded-pill">${tag}</span>
                <span>${content}</span>
            `;
            traceList.appendChild(li);
        });

        const fillList = (id, list, color) => {
            document.getElementById(id).innerHTML = list.map(item =>
                `<span class="badge bg-${color}-subtle text-${color} border border-${color}-subtle px-3 py-2 rounded-pill">${item}</span>`
            ).join('');
        };
        fillList('suitableList', ['Aå­—è£™', 'è¥¯è¡«'], 'success');
        fillList('avoidList', data.result.avoid, 'secondary');
    });
}
</script>
<style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    .dashed-border { border-style: dashed; }
</style>
{% endblock %}
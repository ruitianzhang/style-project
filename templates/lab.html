{% extends "base.html" %}

{% block content %}
<div class="container py-5">

    <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: #D4A5A5;">ğŸ§ª é¢¨æ ¼å¯¦é©—å®¤</h2>
        <p class="text-muted">æ¢ç´¢ã€æ¨¡æ“¬ã€ç†è§£ AI çš„æ±ºç­–éç¨‹</p>
    </div>

    <ul class="nav nav-pills mb-4 justify-content-center gap-2" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active rounded-pill px-4 border" data-bs-toggle="pill" data-bs-target="#tab-xai">
                <i class="fas fa-brain me-2"></i>é€æ˜åŒ–æ¨è–¦ (XAI)
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill px-4 border" data-bs-toggle="pill" data-bs-target="#tab-visual">
                <i class="fas fa-eye me-2"></i>è¦–è¦ºéŒ¯è¦ºæ¨¡æ“¬
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill px-4 border" data-bs-toggle="pill" data-bs-target="#tab-stability">
                <i class="fas fa-chart-line me-2"></i>é¢¨æ ¼ç©©å®šåº¦
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link rounded-pill px-4 border" data-bs-toggle="pill" data-bs-target="#tab-safe">
                <i class="fas fa-shield-alt me-2"></i>å®‰å¿ƒç©¿æ­
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <div class="tab-pane fade show active" id="tab-xai">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="glass-card">
                        <h5 class="fw-bold mb-3 text-primary">ğŸ’¡ ç‚ºä»€éº¼ AI æ¨è–¦é€™å€‹ï¼Ÿ</h5>
                        <p class="text-muted small">èª¿æ•´ä¸‹æ–¹çš„æ¬Šé‡æ»‘å‹•æ¢ï¼Œçœ‹çœ‹ AI æ˜¯å¦‚ä½•æ ¹æ“šä¸åŒå› ç´ åšå‡ºæ±ºç­–çš„ã€‚</p>

                        <div class="mb-4">
                            <label class="form-label d-flex justify-content-between">
                                <span>ğŸ˜¶ è‡‰å‹ä¿®é£¾</span> <span id="val-face">40%</span>
                            </label>
                            <input type="range" class="form-range" id="range-face" min="0" max="100" value="40" oninput="updateSliders()">
                        </div>
                        <div class="mb-4">
                            <label class="form-label d-flex justify-content-between">
                                <span>ğŸ’ƒ èº«ææ¯”ä¾‹</span> <span id="val-body">40%</span>
                            </label>
                            <input type="range" class="form-range" id="range-body" min="0" max="100" value="40" oninput="updateSliders()">
                        </div>
                        <div class="mb-4">
                            <label class="form-label d-flex justify-content-between">
                                <span>â¤ï¸ å€‹äººåå¥½</span> <span id="val-pref">20%</span>
                            </label>
                            <input type="range" class="form-range" id="range-pref" min="0" max="100" value="20" oninput="updateSliders()">
                        </div>

                        <div class="alert alert-light border mt-3">
                            <strong>ğŸ¤– AI æ±ºç­–é‚è¼¯ï¼š</strong>
                            <p class="mb-0 mt-2" id="xai-reason">é€™æ˜¯ä¸€å€‹å®Œç¾çš„å¹³è¡¡é¸æ“‡ï¼Œå…¼é¡§äº†ä¿®é£¾æ€§èˆ‡å€‹äººé¢¨æ ¼ã€‚</p>
                        </div>
                    </div>

                    <div class="glass-card border-danger">
                        <h5 class="fw-bold mb-3 text-danger"><i class="fas fa-thumbs-down me-2"></i>åå‘æ¨è–¦ï¼šæˆ‘ä¸å–œæ­¡...</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-danger rounded-pill" onclick="testReverse('skinny_jeans')">ç·Šèº«è¤²</button>
                            <button class="btn btn-outline-danger rounded-pill" onclick="testReverse('crop_top')">çŸ­ç‰ˆä¸Šè¡£</button>
                            <button class="btn btn-outline-danger rounded-pill" onclick="testReverse('high_neck')">é«˜é ˜è¡«</button>
                        </div>
                        <div id="reverse-reason" class="mt-3 text-danger small fw-bold"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-visual">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="glass-card text-center">
                        <h5 class="fw-bold mb-4">è…°ç·šä½ç½®å°æ¯”ä¾‹çš„å½±éŸ¿</h5>

                        <div class="position-relative mx-auto bg-light border rounded" style="width: 200px; height: 400px; overflow: hidden;">
                            <div id="sim-top" class="bg-primary opacity-75 position-absolute w-100" style="height: 40%; top: 0; transition: 0.3s;"></div>
                            <div id="sim-bottom" class="bg-dark opacity-75 position-absolute w-100" style="height: 60%; bottom: 0; transition: 0.3s;"></div>
                            <img src="https://i.imgur.com/7Z8Qy9M.png" class="position-absolute top-0 start-0 w-100 h-100" style="opacity: 0.3; object-fit: contain; pointer-events: none;" alt="Silhouette">
                        </div>

                        <div class="mt-4">
                            <label class="form-label">èª¿æ•´è…°ç·šä½ç½®</label>
                            <input type="range" class="form-range" min="20" max="60" value="40" oninput="updateWaist(this.value)">
                            <div class="d-flex justify-content-between small text-muted">
                                <span>ä½è…° (é¡¯è…°é•·)</span>
                                <span>é«˜è…° (é¡¯è…¿é•·)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-stability">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="glass-card text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-chart-pie fa-4x text-info"></i>
                        </div>
                        <h3 class="fw-bold text-dark">{{ stability }}</h3>
                        <p class="text-muted mt-3">
                            æ­¤æŒ‡æ¨™åˆ†ææ‚¨æœ€è¿‘ 5 æ¬¡çš„ç©¿æ­åå¥½è®Šç•°ç¨‹åº¦ã€‚<br>
                            {% if stability == 'é¢¨æ ¼ç©©å®šå‹ (Stable)' %}
                                æ‚¨å¾ˆæ¸…æ¥šè‡ªå·±é©åˆä»€éº¼ï¼Œç¹¼çºŒä¿æŒï¼
                            {% elif stability == 'å¤šå…ƒå˜—è©¦æœŸ (Versatile)' %}
                                æ‚¨æ­£åœ¨å‹‡æ–¼å˜—è©¦å„ç¨®é¢¨æ ¼ï¼Œé€™æ˜¯å¥½äº‹ï¼
                            {% else %}
                                è®“æˆ‘å€‘å¤šåšå¹¾æ¬¡åˆ†æï¼Œæ‰¾å‡ºæ‚¨çš„å‘½å®šé¢¨æ ¼å§ã€‚
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-safe">
            <div class="row justify-content-center">
                <div class="col-md-6 text-center">
                    <div class="glass-card py-5">
                        <i class="fas fa-feather-alt fa-3x text-success mb-3"></i>
                        <h4 class="fw-bold">ä¸æƒ³å‹•è…¦ï¼Ÿ</h4>
                        <p class="text-muted">é»æ“ŠæŒ‰éˆ•ï¼ŒAI çµ¦æ‚¨æœ€å®‰å…¨ã€çµ•ä¸å‡ºéŒ¯çš„èˆ’é©é¸æ“‡ã€‚</p>
                        <button class="btn btn-success btn-lg rounded-pill shadow px-5 mt-3" onclick="getSafeChoice()">
                            å¹«æˆ‘é¸ä¸€å¥—
                        </button>

                        <div id="safe-result" class="mt-4 d-none fade-in">
                            <div class="card border-success mb-3">
                                <div class="card-header bg-success text-white fw-bold" id="safe-title"></div>
                                <div class="card-body text-success">
                                    <p class="card-text" id="safe-desc"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// 1. XAI æ»‘å‹•æ¢é‚è¼¯
function updateSliders() {
    let face = document.getElementById('range-face').value;
    let body = document.getElementById('range-body').value;
    let pref = document.getElementById('range-pref').value;

    document.getElementById('val-face').innerText = face + '%';
    document.getElementById('val-body').innerText = body + '%';
    document.getElementById('val-pref').innerText = pref + '%';

    // Debounce API call could be added here
    fetch('/api/lab/recalc_xai', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ face: face, body: body, pref: pref })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('xai-reason').innerText = data.reason;
    });
}

// 2. åå‘æ¨è–¦
function testReverse(type) {
    fetch('/api/lab/reverse_rec', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ type: type })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('reverse-reason').innerText = "ğŸš« " + data.explanation;
    });
}

// 3. è¦–è¦ºéŒ¯è¦º (CSS)
function updateWaist(val) {
    // val è¶Šå° = ä¸Šèº«è¶ŠçŸ­ = é«˜è…°
    // val è¶Šå¤§ = ä¸Šèº«è¶Šé•· = ä½è…°
    // Input range is 20 (High) to 60 (Low)
    document.getElementById('sim-top').style.height = val + '%';
    document.getElementById('sim-bottom').style.height = (100 - val) + '%';
}

// 4. å®‰å¿ƒç©¿æ­
function getSafeChoice() {
    fetch('/api/lab/safe_choice', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        let res = document.getElementById('safe-result');
        res.classList.remove('d-none');
        document.getElementById('safe-title').innerText = data.data.title;
        document.getElementById('safe-desc').innerText = data.data.desc;
    });
}
</script>

<style>
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
</style>
{% endblock %}
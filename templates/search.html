{% extends "base.html" %}
{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: #D4A5A5;">ğŸ” å…¨çƒç©¿æ­æœå°‹å¼•æ“</h2>
        <p class="text-muted">æ¢ç´¢å–®å“ï¼ŒåŒæ™‚ç™¼ç¾ç¤¾ç¾¤çš„ç©¿æ­éˆæ„Ÿ</p>

        <div class="input-group mt-3 shadow-sm rounded-pill overflow-hidden" style="max-width: 600px; margin: 0 auto;">
            <input type="text" id="searchKey" class="form-control border-0 px-4" placeholder="è¼¸å…¥é—œéµå­—ï¼šç´„æœƒã€äºéº»ã€é¡¯ç˜¦...">
            <button class="btn text-white px-4" style="background-color: #D4A5A5;" onclick="doSearch()">æœå°‹</button>
        </div>

        <div class="mt-3">
            <span class="badge bg-light text-dark border me-1 cursor-pointer" onclick="quickSearch('é¢è©¦')">#é¢è©¦</span>
            <span class="badge bg-light text-dark border me-1 cursor-pointer" onclick="quickSearch('ç´„æœƒ')">#ç´„æœƒ</span>
            <span class="badge bg-light text-dark border me-1 cursor-pointer" onclick="quickSearch('å¤å¤©')">#å¤å¤©</span>
            <span class="badge bg-light text-dark border me-1 cursor-pointer" onclick="quickSearch('é¡¯ç˜¦')">#é¡¯ç˜¦</span>
        </div>
    </div>

    <div id="loading" class="text-center d-none">
        <div class="spinner-border text-secondary" role="status"></div>
        <p class="text-muted mt-2">AI æ­£åœ¨æœå°‹è³‡æ–™åº«...</p>
    </div>

    <div id="resultsArea">
        <div class="text-center text-muted py-5">
            <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
            <p>è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æ¢ç´¢</p>
        </div>
    </div>
</div>

<script>
function doSearch() {
    let key = document.getElementById('searchKey').value.trim();
    if (!key) return;

    // é¡¯ç¤º Loadingï¼Œéš±è—èˆŠçµæœ
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('resultsArea').innerHTML = '';

    fetch('/api/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ keyword: key })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('loading').classList.add('d-none');
        const area = document.getElementById('resultsArea');

        if (data.status !== 'success' || data.count === 0) {
            area.innerHTML = `
                <div class="text-center py-5">
                    <h5 class="text-muted">æ‰¾ä¸åˆ°èˆ‡ã€Œ${key}ã€ç›¸é—œçš„çµæœ</h5>
                    <p>è©¦è©¦çœ‹å…¶ä»–é—œéµå­—ï¼Ÿ</p>
                </div>`;
            return;
        }

        let htmlContent = '';

        // 1. é¡¯ç¤ºç›¸é—œå–®å“ (Items)
        if (data.results.items && data.results.items.length > 0) {
            htmlContent += `<h4 class="mb-3 fw-bold border-start border-4 ps-3" style="border-color: #D4A5A5 !important;">ğŸ›ï¸ æ¨è–¦å–®å“</h4>`;
            htmlContent += `<div class="row g-4 mb-5">`;

            data.results.items.forEach(item => {
                // è™•ç†åœ–ç‰‡è·¯å¾‘ (å¦‚æœå¾Œç«¯å›å‚³çš„æ˜¯ç›¸å°è·¯å¾‘)
                let imgSrc = item.image.startsWith('http') ? item.image : `/static/${item.image}`;

                htmlContent += `
                    <div class="col-md-3 col-sm-6">
                        <div class="card border-0 shadow-sm h-100 product-card">
                            <div class="position-relative">
                                <img src="${imgSrc}" class="card-img-top" style="height: 250px; object-fit: cover;">
                                <span class="position-absolute top-0 end-0 badge bg-dark m-2 opacity-75">${item.brand}</span>
                            </div>
                            <div class="card-body">
                                <h6 class="card-title fw-bold text-truncate">${item.title}</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-danger fw-bold">NT$ ${item.price}</span>
                                </div>
                                <button class="btn btn-sm w-100 text-white rounded-pill"
                                        style="background-color: #D4A5A5;"
                                        onclick='addFav(${JSON.stringify(item)})'>
                                    <i class="far fa-heart me-1"></i> åŠ å…¥æ”¶è—
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            htmlContent += `</div>`;
        }

        // 2. é¡¯ç¤ºç¤¾ç¾¤è¨è«– (Posts)
        if (data.results.posts && data.results.posts.length > 0) {
            htmlContent += `<h4 class="mb-3 fw-bold border-start border-4 ps-3" style="border-color: #888 !important;">ğŸ’¬ ç¤¾ç¾¤éˆæ„Ÿ</h4>`;
            htmlContent += `<div class="row g-3">`;

            data.results.posts.forEach(post => {
                let imgSrc = post.image.startsWith('http') ? post.image : `/static/${post.image}`;

                htmlContent += `
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="row g-0 align-items-center">
                                <div class="col-4">
                                    <img src="${imgSrc}" class="img-fluid rounded-start h-100" style="object-fit: cover; min-height: 120px;">
                                </div>
                                <div class="col-8">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between text-muted small mb-1">
                                            <span><i class="fas fa-user-circle me-1"></i>${post.author}</span>
                                            <span><i class="fas fa-heart me-1 text-danger"></i>${post.likes}</span>
                                        </div>
                                        <p class="card-text small mb-0 text-truncate-2">${post.content}</p>
                                        <a href="/community" class="stretched-link"></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            htmlContent += `</div>`;
        }

        area.innerHTML = htmlContent;
    })
    .catch(err => {
        console.error(err);
        document.getElementById('loading').classList.add('d-none');
        alert('æœå°‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    });
}

function addFav(item) {
    // å‡è¨­å¾Œç«¯æœ‰ä¸€å€‹æ”¶è— API
    fetch('/api/add_favorite', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ item_id: item.id })
    })
    .then(r => r.json())
    .then(data => {
        if(data.status === 'success') {
            alert('â¤ï¸ å·²åŠ å…¥æ”¶è—æ¸…å–®ï¼');
        } else {
            alert('è«‹å…ˆç™»å…¥');
            window.location.href = '/login';
        }
    });
}

function quickSearch(k) {
    document.getElementById('searchKey').value = k;
    doSearch();
}

// ç¶å®š Enter éµ
document.getElementById('searchKey').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        doSearch();
    }
});
</script>

<style>
/* é™åˆ¶æ–‡å­—è¡Œæ•¸çš„ CSS */
.text-truncate-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.cursor-pointer {
    cursor: pointer;
}
.product-card:hover {
    transform: translateY(-5px);
    transition: transform 0.3s ease;
}
</style>
{% endblock %}